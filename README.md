# Телеграм бот Наумова

Телеграм бот для сбора контактных данных и запросов от пользователей с автоматической отправкой резервных копий базы данных.

## Функциональность

### Для пользователей:
- Приветствие и запрос контакта
- Сбор запросов в различных форматах (текст, фото, голосовые, видеокружки)
- Возможность изменить или завершить запрос

### Для администраторов:
- Команды в меню справа от строки ввода (видны только администраторам)
- Просмотр всех пользователей (/show_users)
- Просмотр сегодняшних регистраций (/show_today)
- Экспорт данных в Google Sheets (/export_sheets)
- Просмотр и прослушивание медиафайлов (фото, голосовые, видеокружки)
- Автоматическое получение резервных копий базы данных

## Установка и настройка

### Вариант 1: Быстрая установка как служба (рекомендуется)

#### 1. Подготовка сервера
Убедитесь, что на сервере установлен Python 3.12:
```bash
python3.12 --version
```

#### 2. Создание бота в Telegram
1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен

#### 3. Установка как служба
```bash
# Сделать скрипты исполняемыми
chmod +x *.sh

# Установить бота как службу
sudo ./deploy.sh install

# Настроить переменные окружения
sudo ./setup_env.sh

# Запустить бота
sudo ./deploy.sh start
```

#### 4. Управление службой
```bash
# Просмотр статуса
sudo ./deploy.sh status

# Просмотр логов
sudo ./deploy.sh logs

# Перезапуск
sudo ./deploy.sh restart

# Остановка
sudo ./deploy.sh stop

# Обновление файлов
sudo ./deploy.sh update

# Настройка ограничения логов (10 МБ)
sudo ./deploy.sh setup-logging

# Просмотр размера логов
sudo ./deploy.sh logs-size

# Очистка старых логов
sudo ./deploy.sh logs-clean

# Тестирование резервных копий
sudo ./deploy.sh test-backup

### Вариант 2: Ручная установка

#### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

#### 2. Настройка конфигурации
1. Скопируйте файл `config.env.example` в `.env`:
```bash
cp config.env.example .env
```

2. Отредактируйте файл `.env`:
```env
# Токен бота от @BotFather
BOT_TOKEN=your_bot_token_here

# ID администраторов (через запятую)
ADMINS=123456789,987654321

# ID для отправки резервных копий
BACKUPTO=123456789
```

#### 3. Получение Telegram ID
Для получения вашего Telegram ID:
1. Найдите бота @userinfobot в Telegram
2. Отправьте ему любое сообщение
3. Скопируйте ваш ID из ответа

#### 4. Миграция базы данных (если обновляете существующий бот)
```bash
python migrate_db.py
```

#### 5. Запуск бота
```bash
python simple_bot.py
```

## Структура проекта

```
├── simple_bot.py          # Основной файл бота
├── database.py            # Модуль для работы с базой данных
├── keyboards.py           # Клавиатуры и кнопки
├── backup_service.py      # Сервис резервных копий
├── migrate_db.py          # Скрипт миграции базы данных
├── requirements.txt       # Зависимости Python
├── config.env.example     # Пример конфигурации
├── README.md             # Документация
├── naumovado.db          # База данных (создается автоматически)
├── naumova-bot.service   # systemd служба
├── install_service.sh    # Скрипт установки службы
├── uninstall_service.sh  # Скрипт удаления службы
├── deploy.sh             # Скрипт управления развертыванием
└── setup_env.sh          # Скрипт настройки переменных окружения
```

## База данных

База данных SQLite (`naumovado.db`) содержит таблицу `users` со следующими полями:
- `id` - автоинкрементный ID
- `telegram_id` - ID пользователя в Telegram
- `first_name` - имя пользователя
- `last_name` - фамилия пользователя
- `phone` - номер телефона
- `registration_timestamp` - время регистрации
- `request` - запрос пользователя
- `request_type` - тип контента (text, photo, voice, video_note)
- `file_id` - ID файла в Telegram для медиаконтента

## Автоматические резервные копии

Бот автоматически отправляет резервную копию базы данных каждый день в 21:00 на указанный в `BACKUPTO` ID.

## Команды бота

- `/start` - начало работы с ботом
- `/help` - справка по использованию бота

### Команды для администраторов:
- `/show_users` - показать всех пользователей
- `/show_today` - показать сегодняшние регистрации

## Требования

- Python 3.8+
- Доступ к интернету
- Токен Telegram бота
- Telegram ID администраторов

## Безопасность

- Все конфиденциальные данные хранятся в файле `.env`
- База данных защищена от SQL-инъекций
- Доступ к админским функциям ограничен по ID
- Служба запускается под отдельным пользователем `telegram`
- Файлы конфигурации защищены правами доступа 600

## Поддержка

При возникновении проблем проверьте:
1. Правильность токена бота
2. Корректность Telegram ID в конфигурации
3. Наличие всех зависимостей
4. Права доступа к файлам 