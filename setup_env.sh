#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Naumova Telegram Bot
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./setup_env.sh

set -e

BOT_DIR="/opt/telegram_bots/NaumovaDO_biznesscouch"
ENV_FILE="$BOT_DIR/.env"

echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Naumova Telegram Bot"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð»Ð¸ Ð±Ð¾Ñ‚
if [ ! -d "$BOT_DIR" ]; then
    echo "âŒ Ð‘Ð¾Ñ‚ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: ./deploy.sh install"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ .env Ñ„Ð°Ð¹Ð»
if [ -f "$ENV_FILE" ]; then
    echo "â„¹ï¸  Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚."
    read -p "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐµÐ³Ð¾? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°."
        exit 1
    fi
fi

echo ""
echo "ðŸ“ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð¾Ñ‚Ð°:"
echo ""

# Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°
read -p "ðŸ¤– Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¾Ñ‚ @BotFather: " BOT_TOKEN
if [ -z "$BOT_TOKEN" ]; then
    echo "âŒ Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½!"
    exit 1
fi

# Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ID Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
read -p "ðŸ‘¥ ID Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² (Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ): " ADMINS
if [ -z "$ADMINS" ]; then
    echo "âŒ ID Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹!"
    exit 1
fi

# Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ID Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹
read -p "ðŸ’¾ ID Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹: " BACKUPTO
if [ -z "$BACKUPTO" ]; then
    echo "âŒ ID Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½!"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° .env..."
cat > "$ENV_FILE" << EOF
# Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¾Ñ‚ @BotFather
BOT_TOKEN=$BOT_TOKEN

# ID Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² (Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ)
ADMINS=$ADMINS

# ID Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹
BACKUPTO=$BACKUPTO
EOF

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
chown telegram:telegram "$ENV_FILE"
chmod 600 "$ENV_FILE"

echo ""
echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
echo "ðŸ“ Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: $ENV_FILE"
echo ""
echo "ðŸ“‹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
echo "   Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: ${BOT_TOKEN:0:10}..."
echo "   ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹: $ADMINS"
echo "   Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸: $BACKUPTO"
echo ""
echo "ðŸš€ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°:"
echo "   ./deploy.sh restart" 